<div class="page-container">
    <div class="loading-overlay" *ngIf="loading">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>{{ loadingMessage }}</p>
        </div>
    </div>
    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <h1>ThreadClear</h1>
        </div>
        <div class="header-right">
            <span class="logged-in-user" *ngIf="currentUser">{{ userEmail }}</span>
            <button class="btn-admin" *ngIf="isAdmin" (click)="goToAdmin()">Admin Dashboard</button>
            <button class="btn-logout" (click)="logout()">Logout</button>
        </div>
    </header>

    <div class="analyzer-container">
        <div class="input-section">
            <!-- Tab Toggle -->
            <div class="input-tabs">
                <button [class.active]="inputMode === 'text'" (click)="inputMode = 'text'">
                    Paste Text
                </button>
                <button [class.active]="inputMode === 'image'" (click)="inputMode = 'image'">
                    Upload Screenshot
                </button>
                <button [class.active]="inputMode === 'audio'" (click)="inputMode = 'audio'">
                    Upload Audio
                </button>
            </div>

            <!-- Text Input -->
            <div *ngIf="inputMode === 'text'">
                <textarea [(ngModel)]="conversationText"
                    placeholder="Paste your conversation here...&#10;&#10;Example:&#10;John: Can you send the proposal?&#10;Jane: I'll send it today."
                    rows="10">
                </textarea>

                <!-- NEW: Draft Message Input -->
                <div class="draft-input-section">
                    <label class="draft-label">Your Draft Reply (optional)</label>
                    <textarea [(ngModel)]="draftMessage"
                        placeholder="Paste your draft response to analyze before sending...&#10;&#10;Leave empty to analyze conversation only."
                        rows="5" class="draft-textarea">
                    </textarea>
                    <p class="draft-hint">Get feedback on your reply before you send it</p>
                </div>
            </div>

            <!-- Image Upload -->
            <div *ngIf="inputMode === 'image'" class="image-upload">
                <div class="drop-zone" (click)="fileInput.click()" (dragover)="onDragOver($event)"
                    (drop)="onDrop($event)">
                    <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" multiple hidden>
                    <div *ngIf="selectedImages.length === 0">
                        <span class="upload-icon">ðŸ“·</span>
                        <p>Click or drag to upload screenshots</p>
                        <p class="hint"><strong>Or press Ctrl+V to paste from clipboard</strong></p>
                        <p class="hint">Supports: PNG, JPG, JPEG, GIF, WebP</p>
                        <p class="hint">Upload multiple images in order to reconstruct a conversation</p>
                        <p class="hint">Maximum 10 images, 10MB each</p>
                    </div>
                </div>

                <!-- Image Previews -->
                <div *ngIf="selectedImages.length > 0" class="image-previews">
                    <p class="image-count">{{ selectedImages.length }} of 10 images</p>
                    <div class="preview-item" *ngFor="let img of selectedImages; let i = index">
                        <span class="image-number">{{ i + 1 }}</span>
                        <img [src]="imagePreviews[i]" alt="Preview {{ i + 1 }}">
                        <button class="remove-btn" (click)="removeImage(i)">âœ•</button>
                    </div>
                    <div class="add-more" *ngIf="selectedImages.length < 10" (click)="fileInput.click()">
                        <span>+ Add More</span>
                    </div>
                </div>
            </div>

            <div *ngIf="inputMode === 'audio'" class="audio-upload">
                <div class="drop-zone" (click)="audioInput.click()" (dragover)="onDragOver($event)"
                    (drop)="onDropAudio($event)">
                    <input type="file" #audioInput (change)="onAudioSelected($event)"
                        accept="audio/*,.mp3,.wav,.m4a,.webm,.ogg" hidden>
                    <div *ngIf="!selectedAudio">
                        <span class="upload-icon">ðŸŽ¤</span>
                        <p>Click or drag to upload an audio file</p>
                        <p class="hint">Supports: MP3, WAV, M4A, WebM, OGG</p>
                        <p class="hint">Maximum 25MB, up to 60 minutes</p>
                    </div>
                    <div *ngIf="selectedAudio" class="audio-preview">
                        <span class="audio-icon">ðŸŽµ</span>
                        <p class="audio-name">{{ selectedAudio.name }}</p>
                        <p class="audio-size">{{ formatFileSize(selectedAudio.size) }}</p>
                        <button class="remove-btn" (click)="removeAudio($event)">âœ• Remove</button>
                    </div>
                </div>
            </div>

            <div class="controls">
                <label>
                    Source Type:
                    <select [(ngModel)]="sourceType">
                        <option value="auto">Auto (Detect)</option>
                        <option value="simple">Simple</option>
                        <option value="email">Email</option>
                        <option value="slack">Slack</option>
                        <option value="teams">Teams</option>
                    </select>
                </label>

                <label>
                    Parsing Mode:
                    <select [(ngModel)]="parsingMode">
                        <option [ngValue]="0">Basic (Free)</option>
                        <option [ngValue]="1">Advanced (AI)</option>
                        <option [ngValue]="2">Auto (Smart)</option>
                    </select>
                </label>

                <button (click)="analyze()"
                    [disabled]="loading || (!conversationText && selectedImages.length === 0 && !selectedAudio)">
                    {{ loading ? 'Analyzing...' : (draftMessage ? 'Analyze with Draft' : 'Analyze') }}
                </button>
                <button (click)="clear()" [disabled]="loading" class="clear-btn">
                    Clear
                </button>
            </div>

            <!-- Permission Info -->
            <div class="permissions-info" *ngIf="permissions && !isAdmin">
                <p>Your enabled features:</p>
                <div class="feature-badges">
                    <span class="feature-badge"
                        [class.enabled]="permissions.UnansweredQuestions || permissions.unansweredQuestions">Unanswered
                        Questions</span>
                    <span class="feature-badge"
                        [class.enabled]="permissions.TensionPoints || permissions.tensionPoints">Tension Points</span>
                    <span class="feature-badge"
                        [class.enabled]="permissions.Misalignments || permissions.misalignments">Misalignments</span>
                    <span class="feature-badge"
                        [class.enabled]="permissions.ConversationHealth || permissions.conversationHealth">Conversation
                        Health</span>
                    <span class="feature-badge"
                        [class.enabled]="permissions.SuggestedActions || permissions.suggestedActions">Suggested
                        Actions</span>
                </div>
            </div>
        </div>

        <div class="error" *ngIf="error">{{ error }}</div>

        <!-- NEW: Draft Analysis Results -->
        <div class="draft-analysis-section" *ngIf="draftAnalysis">
            <h2>Draft Analysis</h2>

            <!-- Ready to Send Indicator -->
            <div class="ready-indicator" [class.ready]="draftAnalysis.readyToSend"
                [class.needs-work]="!draftAnalysis.readyToSend">
                {{ draftAnalysis.readyToSend ? 'âœ“ Ready to Send' : 'âš  Needs Work' }}
            </div>

            <!-- Overall Assessment -->
            <p class="overall-assessment">{{ draftAnalysis.overallAssessment }}</p>

            <!-- Completeness Score -->
            <div class="completeness-section">
                <h3>Completeness</h3>
                <div class="score-bar-container">
                    <div class="score-bar">
                        <div class="score-fill" [style.width.%]="draftAnalysis.completenessScore * 10"></div>
                    </div>
                    <span class="score-label">{{ draftAnalysis.completenessScore }}/10</span>
                </div>
            </div>

            <!-- Tone Assessment -->
            <div class="tone-section" *ngIf="draftAnalysis.tone">
                <h3>Tone Assessment</h3>
                <div class="tone-badges">
                    <span class="tone-badge">{{ draftAnalysis.tone.tone }}</span>
                    <span class="match-badge" [class.matches]="draftAnalysis.tone.matchesConversationTone"
                        [class.no-match]="!draftAnalysis.tone.matchesConversationTone">
                        {{ draftAnalysis.tone.matchesConversationTone ? 'âœ“ Matches conversation tone' : 'âš  Different
                        tone than conversation' }}
                    </span>
                    <span class="escalation-badge" *ngIf="draftAnalysis.tone.escalationRisk !== 'none'"
                        [class.low]="draftAnalysis.tone.escalationRisk === 'low'"
                        [class.medium]="draftAnalysis.tone.escalationRisk === 'medium'"
                        [class.high]="draftAnalysis.tone.escalationRisk === 'high'">
                        Escalation Risk: {{ draftAnalysis.tone.escalationRisk }}
                    </span>
                </div>
                <p class="tone-explanation">{{ draftAnalysis.tone.explanation }}</p>
            </div>

            <!-- Questions Covered -->
            <div class="questions-section" *ngIf="draftAnalysis.questionsCovered?.length">
                <h3>Questions Addressed</h3>
                <ul class="questions-list">
                    <li *ngFor="let q of draftAnalysis.questionsCovered" [class.addressed]="q.addressed"
                        [class.not-addressed]="!q.addressed">
                        <span class="question-status">{{ q.addressed ? 'âœ“' : 'âœ—' }}</span>
                        <span class="question-text">{{ q.question }}</span>
                        <span class="how-addressed" *ngIf="q.addressed && q.howAddressed">{{ q.howAddressed }}</span>
                    </li>
                </ul>
            </div>

            <!-- Questions Ignored -->
            <div class="warning-section" *ngIf="draftAnalysis.questionsIgnored?.length">
                <h3>âš  Questions Not Addressed</h3>
                <ul class="ignored-list">
                    <li *ngFor="let q of draftAnalysis.questionsIgnored">{{ q }}</li>
                </ul>
            </div>

            <!-- New Questions Introduced -->
            <div class="new-questions-section" *ngIf="draftAnalysis.newQuestionsIntroduced?.length">
                <h3>New Questions You're Asking</h3>
                <ul class="new-questions-list">
                    <li *ngFor="let q of draftAnalysis.newQuestionsIntroduced">{{ q }}</li>
                </ul>
            </div>

            <!-- Risk Flags -->
            <div class="risks-section" *ngIf="draftAnalysis.riskFlags?.length">
                <h3>Risk Flags</h3>
                <div class="risk-item" *ngFor="let risk of draftAnalysis.riskFlags"
                    [class.low]="risk.severity === 'low'" [class.medium]="risk.severity === 'medium'"
                    [class.high]="risk.severity === 'high'">
                    <div class="risk-header">
                        <span class="risk-type">{{ risk.type }}</span>
                        <span class="risk-severity">{{ risk.severity }}</span>
                    </div>
                    <p class="risk-description">{{ risk.description }}</p>
                    <p class="risk-suggestion">ðŸ’¡ {{ risk.suggestion }}</p>
                </div>
            </div>

            <!-- Suggestions -->
            <div class="suggestions-section" *ngIf="draftAnalysis.suggestions?.length">
                <h3>Suggestions</h3>
                <ul class="suggestions-list">
                    <li *ngFor="let s of draftAnalysis.suggestions">{{ s }}</li>
                </ul>
            </div>
        </div>

        <app-results-display *ngIf="results" [results]="results"></app-results-display>
    </div>
</div>