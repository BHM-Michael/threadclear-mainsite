<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreadClear - Analyze Draft</title>
    
    <!-- Office.js library -->
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            color: var(--gray-800);
            background: var(--gray-50);
            padding: 16px;
            line-height: 1.5;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header h1 small {
            display: block;
            font-size: 12px;
            font-weight: 400;
            color: var(--gray-600);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            margin: 16px 0;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .status.loading {
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .status.error {
            background: #fef2f2;
            color: var(--danger);
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Results Section */
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        /* Ready to Send Card */
        .ready-card {
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .ready-card.ready {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid var(--success);
        }
        
        .ready-card.not-ready {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid var(--warning);
        }
        
        .ready-card .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .ready-card h2 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .ready-card p {
            font-size: 13px;
            color: var(--gray-600);
        }
        
        /* Completeness Score */
        .completeness {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .completeness h3 {
            font-size: 13px;
            margin-bottom: 10px;
        }
        
        .completeness-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .completeness-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .completeness-fill.high { background: var(--success); }
        .completeness-fill.medium { background: var(--warning); }
        .completeness-fill.low { background: var(--danger); }
        
        .completeness-label {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 12px;
            color: var(--gray-600);
        }
        
        /* Tone Card */
        .tone-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tone-card h3 {
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tone-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .tone-badge.friendly { background: #dcfce7; color: #166534; }
        .tone-badge.neutral { background: #e0e7ff; color: #3730a3; }
        .tone-badge.formal { background: #dbeafe; color: #1e40af; }
        .tone-badge.defensive { background: #fef3c7; color: #92400e; }
        .tone-badge.aggressive { background: #fee2e2; color: #991b1b; }
        
        .escalation-risk {
            margin-top: 10px;
            padding: 8px;
            background: var(--gray-50);
            border-radius: 6px;
            font-size: 12px;
        }
        
        .escalation-risk.none { border-left: 3px solid var(--success); }
        .escalation-risk.low { border-left: 3px solid var(--success); }
        .escalation-risk.medium { border-left: 3px solid var(--warning); }
        .escalation-risk.high { border-left: 3px solid var(--danger); }
        
        /* Issue Cards */
        .issue-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .issue-card h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .issue-item {
            padding: 10px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .issue-item:last-child {
            margin-bottom: 0;
        }
        
        .issue-item.addressed {
            border-left: 3px solid var(--success);
        }
        
        .issue-item.not-addressed {
            border-left: 3px solid var(--danger);
        }
        
        .severity {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .severity.high { background: #fee2e2; color: #991b1b; }
        .severity.medium { background: #fef3c7; color: #92400e; }
        .severity.low { background: #e0e7ff; color: #3730a3; }
        
        /* Suggestions */
        .suggestion-item {
            padding: 10px;
            background: #eff6ff;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid var(--primary);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">TC</div>
        <h1>
            Analyze Draft
            <small>Check before sending</small>
        </h1>
    </div>
    
    <button id="analyze-btn" class="btn btn-primary" onclick="analyzeDraft()">
        <span>‚úçÔ∏è</span> Analyze My Draft
    </button>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div id="results" class="results">
        <!-- Ready to Send -->
        <div id="ready-card" class="ready-card ready">
            <div class="icon">‚úÖ</div>
            <h2 id="ready-title">Ready to Send</h2>
            <p id="ready-message">Your draft looks good!</p>
        </div>
        
        <!-- Completeness Score -->
        <div class="completeness">
            <h3>üìä Completeness Score</h3>
            <div class="completeness-bar">
                <div id="completeness-fill" class="completeness-fill high" style="width: 0%"></div>
            </div>
            <div class="completeness-label">
                <span>Needs work</span>
                <span id="completeness-score">0/10</span>
                <span>Complete</span>
            </div>
        </div>
        
        <!-- Tone Assessment -->
        <div class="tone-card">
            <h3>üé≠ Tone</h3>
            <span id="tone-badge" class="tone-badge neutral">Neutral</span>
            <div id="escalation-risk" class="escalation-risk none">
                <strong>Escalation Risk:</strong> <span id="escalation-text">None</span>
            </div>
        </div>
        
        <!-- Questions Covered -->
        <div id="questions-card" class="issue-card" style="display: none;">
            <h3>‚ùì Question Coverage</h3>
            <div id="questions-list"></div>
        </div>
        
        <!-- Risk Flags -->
        <div id="risks-card" class="issue-card" style="display: none;">
            <h3>‚ö†Ô∏è Risk Flags</h3>
            <div id="risks-list"></div>
        </div>
        
        <!-- Suggestions -->
        <div id="suggestions-card" class="issue-card" style="display: none;">
            <h3>üí° Suggestions</h3>
            <div id="suggestions-list"></div>
        </div>
    </div>
    
    <script>
        let conversationId = null;
        let userEmail = null;
        
        // Initialize Office.js
        Office.onReady((info) => {
            if (info.host === Office.HostType.Outlook) {
                console.log('ThreadClear compose add-in loaded');
                conversationId = Office.context.mailbox.item.conversationId;
                userEmail = Office.context.mailbox.userProfile.emailAddress;
            }
        });
        
        // Analyze the draft
        async function analyzeDraft() {
            const btn = document.getElementById('analyze-btn');
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Analyzing...';
            status.className = 'status loading';
            status.innerHTML = '<span class="spinner"></span> Reading your draft...';
            status.style.display = 'block';
            results.classList.remove('show');
            
            try {
                // Get draft body
                const draftBody = await getDraftBody();
                
                // Get the conversation context (original email being replied to)
                const originalBody = await getOriginalEmailBody();
                
                status.innerHTML = '<span class="spinner"></span> Analyzing draft...';
                
                // Collect email addresses
                const item = Office.context.mailbox.item;
                const emails = await collectEmailAddresses(item);
                
                // Send to ThreadClear API
                const response = await fetch('https://threadclear-functions-fsewbzcsd8fuegdj.eastus-01.azurewebsites.net/api/analyze-draft', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversationId: conversationId,
                        subject: await getSubject(),
                        originalBody: originalBody,
                        draftBody: draftBody,
                        emails: emails,
                        userEmail: userEmail,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Analysis failed');
                }
                
                const data = await response.json();
                
                // Display results
                displayResults(data);
                
                status.style.display = 'none';
                results.classList.add('show');
                
            } catch (error) {
                console.error('Analysis error:', error);
                status.className = 'status error';
                status.textContent = '‚ùå ' + (error.message || 'Failed to analyze draft');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>‚úçÔ∏è</span> Analyze My Draft';
            }
        }
        
        // Get draft body
        function getDraftBody() {
            return new Promise((resolve, reject) => {
                Office.context.mailbox.item.body.getAsync(
                    Office.CoercionType.Text,
                    (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve(result.value);
                        } else {
                            reject(new Error('Failed to get draft body'));
                        }
                    }
                );
            });
        }
        
        // Get original email body (for reply context)
        function getOriginalEmailBody() {
            return new Promise((resolve) => {
                // In compose mode, we may not have direct access to the original
                // We'll try to extract it from quoted text or return empty
                Office.context.mailbox.item.body.getAsync(
                    Office.CoercionType.Text,
                    (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            // Try to find quoted content (usually after "From:" or "On ... wrote:")
                            const body = result.value;
                            const quoteMatch = body.match(/(?:From:|On .+ wrote:)[\s\S]*/i);
                            resolve(quoteMatch ? quoteMatch[0] : '');
                        } else {
                            resolve('');
                        }
                    }
                );
            });
        }
        
        // Get subject
        function getSubject() {
            return new Promise((resolve) => {
                Office.context.mailbox.item.subject.getAsync((result) => {
                    resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value : '');
                });
            });
        }
        
        // Collect email addresses
        async function collectEmailAddresses(item) {
            const emails = new Set();
            emails.add(userEmail.toLowerCase());
            
            // Get To recipients
            await new Promise((resolve) => {
                item.to.getAsync((result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        result.value.forEach(r => {
                            if (r.emailAddress) emails.add(r.emailAddress.toLowerCase());
                        });
                    }
                    resolve();
                });
            });
            
            // Get CC recipients
            await new Promise((resolve) => {
                item.cc.getAsync((result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        result.value.forEach(r => {
                            if (r.emailAddress) emails.add(r.emailAddress.toLowerCase());
                        });
                    }
                    resolve();
                });
            });
            
            return Array.from(emails);
        }
        
        // Display results
        function displayResults(data) {
            const analysis = data.draftAnalysis;
            
            // Ready to send
            const readyCard = document.getElementById('ready-card');
            const readyTitle = document.getElementById('ready-title');
            const readyMessage = document.getElementById('ready-message');
            
            if (analysis.readyToSend) {
                readyCard.className = 'ready-card ready';
                readyTitle.textContent = '‚úÖ Ready to Send';
                readyMessage.textContent = analysis.overallAssessment || 'Your draft looks good!';
            } else {
                readyCard.className = 'ready-card not-ready';
                readyTitle.textContent = '‚ö†Ô∏è Review Suggested';
                readyMessage.textContent = analysis.overallAssessment || 'Consider the suggestions below.';
            }
            
            // Completeness score
            const score = analysis.completenessScore || 5;
            const completeFill = document.getElementById('completeness-fill');
            const completeScore = document.getElementById('completeness-score');
            completeFill.style.width = (score * 10) + '%';
            completeFill.className = 'completeness-fill ' + (score >= 7 ? 'high' : score >= 4 ? 'medium' : 'low');
            completeScore.textContent = score + '/10';
            
            // Tone
            const tone = analysis.tone || {};
            const toneBadge = document.getElementById('tone-badge');
            toneBadge.textContent = tone.tone || 'Neutral';
            toneBadge.className = 'tone-badge ' + (tone.tone || 'neutral').toLowerCase();
            
            const escalationRisk = document.getElementById('escalation-risk');
            const escalationText = document.getElementById('escalation-text');
            const risk = (tone.escalationRisk || 'none').toLowerCase();
            escalationRisk.className = 'escalation-risk ' + risk;
            escalationText.textContent = capitalize(risk);
            
            // Questions covered
            const questions = analysis.questionsCovered || [];
            if (questions.length > 0) {
                document.getElementById('questions-card').style.display = 'block';
                document.getElementById('questions-list').innerHTML = questions.map(q => `
                    <div class="issue-item ${q.addressed ? 'addressed' : 'not-addressed'}">
                        ${q.addressed ? '‚úÖ' : '‚ùå'} "${q.question}"
                        ${q.howAddressed ? `<br><small style="color: var(--gray-600)">${q.howAddressed}</small>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('questions-card').style.display = 'none';
            }
            
            // Risk flags
            const risks = analysis.riskFlags || [];
            if (risks.length > 0) {
                document.getElementById('risks-card').style.display = 'block';
                document.getElementById('risks-list').innerHTML = risks.map(r => `
                    <div class="issue-item">
                        ${r.description}
                        <span class="severity ${(r.severity || 'medium').toLowerCase()}">${r.severity || 'Medium'}</span>
                        ${r.suggestion ? `<br><small style="color: var(--primary)">üí° ${r.suggestion}</small>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('risks-card').style.display = 'none';
            }
            
            // Suggestions
            const suggestions = analysis.suggestions || [];
            if (suggestions.length > 0) {
                document.getElementById('suggestions-card').style.display = 'block';
                document.getElementById('suggestions-list').innerHTML = suggestions.map(s => `
                    <div class="suggestion-item">üí° ${s}</div>
                `).join('');
            } else {
                document.getElementById('suggestions-card').style.display = 'none';
            }
        }
        
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>
