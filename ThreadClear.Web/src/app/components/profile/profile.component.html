<div class="profile-container">
    <h1>My Profile</h1>

    <div class="profile-card" *ngIf="!loading">
        <!-- User Info -->
        <section class="profile-section">
            <h2>Account</h2>
            <div class="info-row">
                <span class="label">Email</span>
                <span class="value">{{ user?.email || user?.Email }}</span>
            </div>
            <div class="info-row">
                <span class="label">Name</span>
                <span class="value" *ngIf="!editingName">
                    {{ user?.displayName || 'Not set' }}
                    <button class="btn-edit" (click)="startEditName()">Edit</button>
                </span>
                <span class="value edit-mode" *ngIf="editingName">
                    <input type="text" [(ngModel)]="editDisplayName" placeholder="Enter your name" />
                    <button class="btn-save" (click)="saveName()" [disabled]="savingName">
                        {{ savingName ? 'Saving...' : 'Save' }}
                    </button>
                    <button class="btn-cancel" (click)="cancelEditName()">Cancel</button>
                </span>
            </div>
            <div class="info-row">
                <span class="label">Password</span>
                <span class="value">
                    ••••••••
                    <button class="btn-edit" (click)="togglePasswordForm()">
                        {{ showPasswordForm ? 'Cancel' : 'Change' }}
                    </button>
                </span>
            </div>

            <!-- Password Change Form -->
            <div class="password-form" *ngIf="showPasswordForm">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" [(ngModel)]="currentPassword" />
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" [(ngModel)]="newPassword" />
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" [(ngModel)]="confirmPassword" />
                </div>
                <div class="password-error" *ngIf="passwordError">{{ passwordError }}</div>
                <div class="password-success" *ngIf="passwordSuccess">{{ passwordSuccess }}</div>
                <button class="btn-change-password" (click)="changePassword()" [disabled]="savingPassword">
                    {{ savingPassword ? 'Changing...' : 'Change Password' }}
                </button>
            </div>
        </section>

        <!-- Current Plan -->
        <section class="profile-section">
            <h2>Subscription</h2>
            <div class="plan-badge" [ngClass]="currentPlan">
                {{ currentPlan | titlecase }} Plan
            </div>
        </section>

        <!-- Usage -->
        <section class="profile-section">
            <h2>Usage This Month</h2>
            <div class="usage-bar-container">
                <div class="usage-bar" [style.width.%]="usagePercentage"></div>
            </div>
            <div class="usage-text">
                {{ analysesUsed }} / {{ analysesLimit }} analyses used
            </div>
        </section>

        <!-- Integrations -->
        <section class="profile-section">
            <h2>Integrations</h2>

            <div class="integration-status" *ngIf="gmailStatus === 'connected'">
                ✓ Gmail connected successfully!
            </div>
            <div class="integration-error" *ngIf="gmailStatus === 'error'">
                Failed to connect Gmail. Please try again.
            </div>

            <div class="integration-row">
                <div class="integration-info">
                    <span class="integration-name">Gmail</span>
                    <span class="integration-detail" *ngIf="gmailConnected">{{ gmailEmail }}</span>
                    <span class="integration-detail" *ngIf="!gmailConnected">Not connected</span>
                </div>
                <button *ngIf="!gmailConnected" class="btn-connect" (click)="connectGmail()"
                    [disabled]="gmailConnecting">
                    Connect Gmail
                </button>
                <span *ngIf="gmailConnected" class="connected-badge">✓ Connected</span>
            </div>
        </section>

        <!-- Upgrade Options -->
        <section class="profile-section" *ngIf="currentPlan === 'free'">
            <h2>Upgrade</h2>
            <div class="upgrade-options">
                <div class="upgrade-card">
                    <h3>Pro</h3>
                    <div class="price">$19.99<span>/month</span></div>
                    <ul>
                        <li>100 analyses/month</li>
                        <li>Priority support</li>
                    </ul>
                    <button class="btn-upgrade" (click)="upgrade(PRO_PRICE_ID)" [disabled]="upgrading">
                        {{ upgrading ? 'Loading...' : 'Upgrade to Pro' }}
                    </button>
                </div>
                <div class="upgrade-card enterprise">
                    <h3>Enterprise</h3>
                    <div class="price">$99.99<span>/month</span></div>
                    <ul>
                        <li>10,000 analyses/month</li>
                        <li>Team management</li>
                        <li>Dedicated support</li>
                    </ul>
                    <button class="btn-upgrade" (click)="upgrade(ENTERPRISE_PRICE_ID)" [disabled]="upgrading">
                        {{ upgrading ? 'Loading...' : 'Upgrade to Enterprise' }}
                    </button>
                </div>
            </div>
            <p class="error" *ngIf="error">{{ error }}</p>
        </section>

        <!-- Already subscribed -->
        <section class="profile-section" *ngIf="currentPlan !== 'free'">
            <p class="subscribed-note">Manage your subscription in the <a href="https://billing.stripe.com/p/login/test"
                    target="_blank">billing portal</a>.</p>
        </section>
    </div>

    <div class="loading" *ngIf="loading">Loading...</div>
</div>