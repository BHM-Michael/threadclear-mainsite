<div class="admin-container">
    <header class="admin-header">
        <h1>Admin Dashboard</h1>
    </header>

    <!-- Tabs -->
    <div class="tabs">
        <button [class.active]="activeTab === 'users'" (click)="setTab('users')">Users</button>
        <button [class.active]="activeTab === 'organizations'" (click)="setTab('organizations')">Organizations</button>
    </div>

    <div class="messages">
        <div class="error" *ngIf="error">{{ error }}</div>
        <div class="success" *ngIf="success">{{ success }}</div>
    </div>

    <!-- ==================== USERS TAB ==================== -->
    <section class="section" *ngIf="activeTab === 'users'">
        <div class="section-header">
            <h2>Users</h2>
            <button class="btn-primary" (click)="showNewUserForm = !showNewUserForm">
                {{ showNewUserForm ? 'Cancel' : '+ Add User' }}
            </button>
        </div>

        <!-- New User Form -->
        <div class="new-user-form" *ngIf="showNewUserForm">
            <h3>Create New User</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="newUser.email" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" [(ngModel)]="newUser.password" placeholder="Password">
                </div>
            </div>

            <div class="permissions-grid">
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="newUser.unansweredQuestions">
                    Unanswered Questions
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="newUser.tensionPoints">
                    Tension Points
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="newUser.misalignments">
                    Misalignments
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="newUser.conversationHealth">
                    Conversation Health
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="newUser.suggestedActions">
                    Suggested Actions
                </label>
            </div>

            <button class="btn-primary" (click)="createUser()" [disabled]="loading">
                {{ loading ? 'Creating...' : 'Create User' }}
            </button>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of users">
                        <td>{{ user.Email }}</td>
                        <td><span class="role-badge" [class.admin]="user.Role === 'admin'">{{ user.Role }}</span></td>
                        <td>
                            <div class="permission-badges" *ngIf="user.Permissions">
                                <span class="perm-badge" [class.enabled]="user.Permissions.UnansweredQuestions"
                                    title="Unanswered Questions">UQ</span>
                                <span class="perm-badge" [class.enabled]="user.Permissions.TensionPoints"
                                    title="Tension Points">TP</span>
                                <span class="perm-badge" [class.enabled]="user.Permissions.Misalignments"
                                    title="Misalignments">MA</span>
                                <span class="perm-badge" [class.enabled]="user.Permissions.ConversationHealth"
                                    title="Conversation Health">CH</span>
                                <span class="perm-badge" [class.enabled]="user.Permissions.SuggestedActions"
                                    title="Suggested Actions">SA</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn-small" (click)="editUser(user)"
                                *ngIf="user.Role !== 'admin'">Edit</button>
                            <button class="btn-small btn-danger" (click)="deleteUser(user)"
                                *ngIf="user.Role !== 'admin'">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Edit User Modal -->
    <div class="modal-overlay" *ngIf="editingUser" (click)="cancelEdit()">
        <div class="modal" (click)="$event.stopPropagation()">
            <h3>Edit Permissions: {{ editingUser.Email }}</h3>

            <div class="permissions-grid">
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editingUser.Permissions.UnansweredQuestions">
                    Unanswered Questions
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editingUser.Permissions.TensionPoints">
                    Tension Points
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editingUser.Permissions.Misalignments">
                    Misalignments
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editingUser.Permissions.ConversationHealth">
                    Conversation Health
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editingUser.Permissions.SuggestedActions">
                    Suggested Actions
                </label>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" (click)="cancelEdit()">Cancel</button>
                <button class="btn-primary" (click)="savePermissions()" [disabled]="loading">
                    {{ loading ? 'Saving...' : 'Save Changes' }}
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== ORGANIZATIONS TAB ==================== -->
    <section class="section" *ngIf="activeTab === 'organizations'">
        <div class="section-header">
            <h2>Organizations</h2>
            <button class="btn-primary" (click)="showNewOrgForm = !showNewOrgForm">
                {{ showNewOrgForm ? 'Cancel' : '+ New Organization' }}
            </button>
        </div>

        <!-- New Organization Form -->
        <div class="new-org-form" *ngIf="showNewOrgForm">
            <h3>Create New Organization</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Organization Name</label>
                    <input type="text" [(ngModel)]="newOrg.name" placeholder="Acme Corp">
                </div>
                <div class="form-group">
                    <label>Owner Email</label>
                    <input type="email" [(ngModel)]="newOrg.ownerEmail" placeholder="owner@acme.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Industry</label>
                    <select [(ngModel)]="newOrg.industryType">
                        <option *ngFor="let ind of industries" [value]="ind.key">{{ ind.name }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Plan</label>
                    <select [(ngModel)]="newOrg.plan">
                        <option *ngFor="let p of plans" [value]="p.key">{{ p.name }}</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" (click)="createOrganization()" [disabled]="loading">
                {{ loading ? 'Creating...' : 'Create Organization' }}
            </button>
        </div>

        <!-- Organizations Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Industry</th>
                        <th>Plan</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let org of organizations" [class.my-org]="isMyOrg(org.id)">
                        <td>
                            <strong>{{ org.name }}</strong>
                            <span *ngIf="isMyOrg(org.id)" class="mine-badge">Mine</span>
                            <small class="slug">{{ org.slug }}</small>
                        </td>
                        <td>{{ org.industryType }}</td>
                        <td><span class="plan-badge" [class]="org.plan">{{ org.plan }}</span></td>
                        <td>
                            <span class="status-badge" [class.active]="org.isActive">
                                {{ org.isActive ? 'Active' : 'Inactive' }}
                            </span>
                        </td>
                        <td>{{ org.createdAt | date:'short' }}</td>
                        <td>
                            <button class="btn-small" (click)="viewOrganization(org)">View</button>
                        </td>
                    </tr>
                    <tr *ngIf="organizations.length === 0">
                        <td colspan="6" class="empty-row">No organizations yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Organization Details Modal -->
    <div class="modal-overlay" *ngIf="selectedOrg" (click)="closeOrgDetails()">
        <div class="modal modal-large" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ selectedOrg.name }}</h3>
                <button class="btn-close" (click)="closeOrgDetails()">Ã—</button>
            </div>

            <!-- Org Settings Tabs -->
            <div class="tabs tabs-secondary">
                <button [class.active]="orgSettingsTab === 'general'"
                    (click)="setOrgSettingsTab('general')">General</button>
                <button [class.active]="orgSettingsTab === 'members'"
                    (click)="setOrgSettingsTab('members')">Members</button>
                <button [class.active]="orgSettingsTab === 'taxonomy'"
                    (click)="setOrgSettingsTab('taxonomy')">Taxonomy</button>
            </div>

            <!-- General Tab -->
            <div class="tab-content" *ngIf="orgSettingsTab === 'general'">
                <div class="form-section">
                    <div class="form-group">
                        <label>Organization Name</label>
                        <input type="text" [(ngModel)]="orgName" placeholder="Organization name">
                    </div>
                    <div class="form-group">
                        <label>Industry</label>
                        <select [(ngModel)]="orgIndustry">
                            <option *ngFor="let ind of industries" [value]="ind.key">{{ ind.name }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Plan</label>
                        <span class="plan-badge" [class]="selectedOrg.plan">{{ selectedOrg.plan }}</span>
                    </div>
                    <div class="form-group">
                        <label>Slug</label>
                        <span class="slug">{{ selectedOrg.slug }}</span>
                    </div>
                    <button class="btn-primary" (click)="saveOrgSettings()" [disabled]="isSaving">
                        {{ isSaving ? 'Saving...' : 'Save Changes' }}
                    </button>
                </div>
            </div>

            <!-- Members Tab -->
            <div class="tab-content" *ngIf="orgSettingsTab === 'members'">
                <div class="section-header">
                    <h4>Members ({{ selectedOrgMembers.length }})</h4>
                    <div class="header-buttons">
                        <button class="btn-small btn-primary" (click)="showInviteForm = !showInviteForm">
                            {{ showInviteForm ? 'Cancel' : '+ Invite' }}
                        </button>
                        <button class="btn-small btn-secondary" (click)="showBulkInviteForm = !showBulkInviteForm">
                            {{ showBulkInviteForm ? 'Cancel' : 'Bulk Invite' }}
                        </button>
                    </div>
                </div>

                <!-- Single Invite Form -->
                <div class="invite-form" *ngIf="showInviteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" [(ngModel)]="inviteRequest.email" placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select [(ngModel)]="inviteRequest.role">
                                <option value="Member">Member</option>
                                <option value="Analyst">Analyst</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <button class="btn-primary" (click)="inviteUser()" [disabled]="loading">
                            {{ loading ? 'Inviting...' : 'Send Invite' }}
                        </button>
                    </div>
                </div>

                <!-- Bulk Invite Form -->
                <div class="bulk-invite-form" *ngIf="showBulkInviteForm">
                    <div class="form-group">
                        <label>Emails (one per line, or comma/semicolon separated)</label>
                        <textarea [(ngModel)]="bulkEmails" rows="5"
                            placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Default Role</label>
                            <select [(ngModel)]="bulkDefaultRole">
                                <option value="Member">Member</option>
                                <option value="Analyst">Analyst</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <button class="btn-primary" (click)="bulkInvite()" [disabled]="loading">
                            {{ loading ? 'Processing...' : 'Send Invites' }}
                        </button>
                    </div>
                </div>

                <!-- Members Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let member of selectedOrgMembers">
                                <td>{{ member.email || 'Pending' }}</td>
                                <td><span class="role-badge">{{ member.role }}</span></td>
                                <td>
                                    <span class="status-badge" [ngClass]="getMemberStatusClass(member.status)">
                                        {{ member.status }}
                                    </span>
                                </td>
                                <td>{{ member.joinedAt ? (member.joinedAt | date:'short') : '-' }}</td>
                                <td>
                                    <button class="btn-small" *ngIf="member.status === 'Invited' && member.inviteToken"
                                        (click)="copyInviteUrl(member.inviteToken)">
                                        Copy Link
                                    </button>
                                    <button class="btn-small" *ngIf="member.status === 'Invited'"
                                        (click)="resendInvite(member)">
                                        Resend
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="selectedOrgMembers.length === 0">
                                <td colspan="5" class="empty-row">No members yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Taxonomy Tab -->
            <div class="tab-content" *ngIf="orgSettingsTab === 'taxonomy'">
                <!-- Topics -->
                <div class="form-section">
                    <h4>Custom Topics</h4>
                    <p class="help-text">Add topics specific to this organization's communication patterns</p>

                    <div class="add-form">
                        <input type="text" [(ngModel)]="newTopicKey" placeholder="Key (e.g., escalation)">
                        <input type="text" [(ngModel)]="newTopicName" placeholder="Display Name">
                        <input type="text" [(ngModel)]="newTopicKeywords" placeholder="Keywords (comma-separated)">
                        <button class="btn-primary" (click)="addTopic()"
                            [disabled]="isSaving || !newTopicKey || !newTopicName">
                            Add Topic
                        </button>
                    </div>

                    <div class="items-list" *ngIf="taxonomy">
                        <div class="item" *ngFor="let topic of taxonomy.topics" [class.custom]="topic.isCustom">
                            <div class="item-info">
                                <span class="item-name">{{ topic.displayName }}</span>
                                <span class="item-key">{{ topic.key }}</span>
                                <span class="item-keywords" *ngIf="topic.keywords?.length">
                                    Keywords: {{ topic.keywords.join(', ') }}
                                </span>
                            </div>
                            <button class="btn-small btn-danger" *ngIf="topic.isCustom" (click)="removeTopic(topic)">
                                Remove
                            </button>
                            <span class="default-badge" *ngIf="!topic.isCustom">Default</span>
                        </div>
                    </div>
                </div>

                <!-- Roles -->
                <div class="form-section">
                    <h4>Custom Roles</h4>
                    <p class="help-text">Add participant roles specific to this organization</p>

                    <div class="add-form">
                        <input type="text" [(ngModel)]="newRoleKey" placeholder="Key (e.g., support_lead)">
                        <input type="text" [(ngModel)]="newRoleName" placeholder="Display Name">
                        <input type="text" [(ngModel)]="newRoleKeywords" placeholder="Keywords (comma-separated)">
                        <button class="btn-primary" (click)="addRole()"
                            [disabled]="isSaving || !newRoleKey || !newRoleName">
                            Add Role
                        </button>
                    </div>

                    <div class="items-list" *ngIf="taxonomy">
                        <div class="item" *ngFor="let role of taxonomy.roles">
                            <div class="item-info">
                                <span class="item-name">{{ role.displayName }}</span>
                                <span class="item-key">{{ role.key }}</span>
                                <span class="item-keywords" *ngIf="role.keywords?.length">
                                    Keywords: {{ role.keywords.join(', ') }}
                                </span>
                            </div>
                            <button class="btn-small btn-danger" (click)="removeRole(role)">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>