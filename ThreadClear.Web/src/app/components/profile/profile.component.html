<div class="profile-container">
    <h1>My Profile</h1>

    <div class="profile-card" *ngIf="!loading">
        <!-- User Info -->
        <section class="profile-section">
            <h2>Account</h2>
            <div class="info-row">
                <span class="label">Email</span>
                <span class="value">{{ user?.email || user?.Email }}</span>
            </div>
            <div class="info-row">
                <span class="label">Name</span>
                <span class="value" *ngIf="!editingName">
                    {{ user?.displayName || 'Not set' }}
                    <button class="btn-edit" (click)="startEditName()">Edit</button>
                </span>
                <span class="value edit-mode" *ngIf="editingName">
                    <input type="text" [(ngModel)]="editDisplayName" placeholder="Enter your name" />
                    <button class="btn-save" (click)="saveName()" [disabled]="savingName">
                        {{ savingName ? 'Saving...' : 'Save' }}
                    </button>
                    <button class="btn-cancel" (click)="cancelEditName()">Cancel</button>
                </span>
            </div>
            <div class="info-row">
                <span class="label">Password</span>
                <span class="value">
                    ••••••••
                    <button class="btn-edit" (click)="togglePasswordForm()">
                        {{ showPasswordForm ? 'Cancel' : 'Change' }}
                    </button>
                </span>
            </div>

            <!-- Password Change Form -->
            <div class="password-success-banner" *ngIf="passwordSuccess && !showPasswordForm">
                ✓ {{ passwordSuccess }}
            </div>
            <div class="password-form" *ngIf="showPasswordForm">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" [(ngModel)]="currentPassword" />
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" [(ngModel)]="newPassword" />
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" [(ngModel)]="confirmPassword" />
                </div>
                <div class="password-error" *ngIf="passwordError">{{ passwordError }}</div>
                <div class="password-success" *ngIf="passwordSuccess">{{ passwordSuccess }}</div>
                <button class="btn-change-password" (click)="changePassword()" [disabled]="savingPassword">
                    {{ savingPassword ? 'Changing...' : 'Change Password' }}
                </button>
            </div>
        </section>

        <!-- Usage -->
        <section class="profile-section">
            <h2>Usage This Month</h2>
            <div class="usage-bar-container">
                <div class="usage-bar" [style.width.%]="usagePercentage"></div>
            </div>
            <div class="usage-text">
                {{ analysesUsed }} / {{ analysesLimit }} analyses used
            </div>
        </section>

        <!-- Integrations -->
        <section class="profile-section">
            <h2>Integrations</h2>

            <div class="integration-status" *ngIf="gmailStatus === 'connected'">
                ✓ Gmail connected successfully!
            </div>
            <div class="integration-error" *ngIf="gmailStatus === 'error'">
                Failed to connect Gmail. Please try again.
            </div>

            <div class="integration-row">
                <div class="integration-info">
                    <span class="integration-name">Gmail</span>
                    <span class="integration-detail" *ngIf="gmailConnected">{{ gmailEmail }}</span>
                    <span class="integration-detail" *ngIf="!gmailConnected">Not connected</span>
                </div>
                <button *ngIf="!gmailConnected" class="btn-connect" (click)="connectGmail()"
                    [disabled]="gmailConnecting">
                    Connect Gmail
                </button>
                <span *ngIf="gmailConnected" class="connected-badge">✓ Connected</span>
            </div>
        </section>

        <!-- Plan Options -->
        <section class="profile-section">
            <h2>Plan</h2>
            <div class="plan-options">
                <!-- Free Plan -->
                <div class="plan-card" [class.selected]="selectedPlan === 'free'"
                    [class.current]="currentPlan === 'free'" (click)="selectPlan('free')">
                    <div class="plan-check" *ngIf="selectedPlan === 'free'">✓</div>
                    <h3>Free</h3>
                    <div class="price">$0<span>/month</span></div>
                    <ul>
                        <li>10 analyses/month</li>
                        <li>Basic features</li>
                    </ul>
                    <div class="current-label" *ngIf="currentPlan === 'free'">Current</div>
                </div>

                <!-- Pro Plan -->
                <div class="plan-card" [class.selected]="selectedPlan === 'pro'" [class.current]="currentPlan === 'pro'"
                    (click)="selectPlan('pro')">
                    <div class="plan-check" *ngIf="selectedPlan === 'pro'">✓</div>
                    <h3>Pro</h3>
                    <div class="price">$19.99<span>/month</span></div>
                    <ul>
                        <li>100 analyses/month</li>
                        <li>Priority support</li>
                    </ul>
                    <div class="current-label" *ngIf="currentPlan === 'pro'">Current</div>
                </div>

                <!-- Enterprise Plan -->
                <div class="plan-card" [class.selected]="selectedPlan === 'enterprise'"
                    [class.current]="currentPlan === 'enterprise'" (click)="selectPlan('enterprise')">
                    <div class="plan-check" *ngIf="selectedPlan === 'enterprise'">✓</div>
                    <h3>Enterprise</h3>
                    <div class="price">$99.99<span>/month</span></div>
                    <ul>
                        <li>10,000 analyses/month</li>
                        <li>Team management</li>
                        <li>Dedicated support</li>
                    </ul>
                    <div class="current-label" *ngIf="currentPlan === 'enterprise'">Current</div>
                </div>
            </div>

            <div class="plan-actions">
                <button class="btn-save-plan" (click)="savePlan()" [disabled]="!planChanged || upgrading">
                    {{ upgrading ? 'Processing...' : 'Save Plan' }}
                </button>
                <span class="plan-hint" *ngIf="!planChanged">Select a different plan to make changes</span>
            </div>

            <p class="error" *ngIf="error">{{ error }}</p>

            <p class="billing-note" *ngIf="currentPlan !== 'free'">
                Manage billing details in the <a href="https://billing.stripe.com/p/login/test_00w7sL3GYdcC3yw9jleIw00"
                    target="_blank">billing portal</a>.
            </p>
        </section>
    </div>

    <div class="loading" *ngIf="loading">Loading...</div>
</div>