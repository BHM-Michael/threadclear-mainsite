<div class="page-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="loading">
        <div class="loading-card">
            <div class="spinner"></div>
            <p class="loading-message">{{ loadingMessage }}</p>
            <p class="loading-hint">This usually takes 10-15 seconds</p>
        </div>
    </div>

    <div class="analyzer-wrapper">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1>Analyze Conversation</h1>
                <p>Paste text, upload screenshots, or submit audio to get insights</p>
            </div>
        </div>

        <div class="analyzer-container">
            <!-- Input Section -->
            <div class="input-section">
                <!-- Tab Toggle -->
                <div class="input-tabs">
                    <button [class.active]="inputMode === 'text'" (click)="inputMode = 'text'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Paste Text
                    </button>
                    <button [class.active]="inputMode === 'image'" (click)="inputMode = 'image'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        Upload Screenshot
                    </button>
                    <button [class.active]="inputMode === 'audio'" (click)="inputMode = 'audio'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                        Upload Audio
                    </button>
                </div>

                <!-- Text Input -->
                <div *ngIf="inputMode === 'text'" class="text-input-section">
                    <div class="textarea-wrapper">
                        <textarea 
                            [(ngModel)]="conversationText"
                            placeholder="Paste your conversation here...

Example:
John: Can you send the proposal?
Jane: I'll send it today.
John: What's the timeline for review?"
                            rows="12">
                        </textarea>
                    </div>

                    <!-- Draft Message Input -->
                    <div class="draft-input-section">
                        <div class="draft-header">
                            <label class="draft-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 20h9"/>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                </svg>
                                Your Draft Reply
                            </label>
                            <span class="draft-optional">Optional</span>
                        </div>
                        <textarea 
                            [(ngModel)]="draftMessage"
                            placeholder="Paste your draft response to get feedback before sending..."
                            rows="4" 
                            class="draft-textarea">
                        </textarea>
                        <p class="draft-hint">We'll check if you've addressed all questions and flag any potential issues</p>
                    </div>
                </div>

                <!-- Image Upload -->
                <div *ngIf="inputMode === 'image'" class="image-upload">
                    <div class="drop-zone" (click)="fileInput.click()" (dragover)="onDragOver($event)" (drop)="onDrop($event)">
                        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" multiple hidden>
                        <div *ngIf="selectedImages.length === 0" class="drop-content">
                            <div class="drop-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </div>
                            <p class="drop-title">Drop screenshots here or click to upload</p>
                            <p class="drop-hint"><strong>Pro tip:</strong> Press Ctrl+V to paste from clipboard</p>
                            <p class="drop-hint">PNG, JPG, GIF, WebP â€¢ Up to 10 images â€¢ 10MB each</p>
                        </div>
                    </div>

                    <!-- Image Previews -->
                    <div *ngIf="selectedImages.length > 0" class="image-previews">
                        <div class="previews-header">
                            <span class="image-count">{{ selectedImages.length }} of 10 images</span>
                            <button class="add-more-btn" *ngIf="selectedImages.length < 10" (click)="fileInput.click()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add More
                            </button>
                        </div>
                        <div class="previews-grid">
                            <div class="preview-item" *ngFor="let img of selectedImages; let i = index">
                                <span class="image-number">{{ i + 1 }}</span>
                                <img [src]="imagePreviews[i]" alt="Preview {{ i + 1 }}">
                                <button class="remove-btn" (click)="removeImage(i)">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Upload -->
                <div *ngIf="inputMode === 'audio'" class="audio-upload">
                    <div class="drop-zone" (click)="audioInput.click()" (dragover)="onDragOver($event)" (drop)="onDropAudio($event)">
                        <input type="file" #audioInput (change)="onAudioSelected($event)" accept="audio/*,.mp3,.wav,.m4a,.webm,.ogg" hidden>
                        <div *ngIf="!selectedAudio" class="drop-content">
                            <div class="drop-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" y1="19" x2="12" y2="23"/>
                                    <line x1="8" y1="23" x2="16" y2="23"/>
                                </svg>
                            </div>
                            <p class="drop-title">Drop audio file here or click to upload</p>
                            <p class="drop-hint">MP3, WAV, M4A, WebM, OGG â€¢ Max 25MB â€¢ Up to 60 minutes</p>
                        </div>
                        <div *ngIf="selectedAudio" class="audio-preview">
                            <div class="audio-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                            </div>
                            <div class="audio-info">
                                <p class="audio-name">{{ selectedAudio.name }}</p>
                                <p class="audio-size">{{ formatFileSize(selectedAudio.size) }}</p>
                            </div>
                            <button class="remove-audio-btn" (click)="removeAudio($event)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <div class="control-group">
                        <label>
                            <span class="control-label">Source Type</span>
                            <select [(ngModel)]="sourceType">
                                <option value="auto">Auto Detect</option>
                                <option value="simple">Simple</option>
                                <option value="email">Email</option>
                                <option value="slack">Slack</option>
                                <option value="teams">Teams</option>
                            </select>
                        </label>

                        <label>
                            <span class="control-label">Analysis Mode</span>
                            <select [(ngModel)]="parsingMode">
                                <option [ngValue]="0">Basic (Free)</option>
                                <option [ngValue]="1">Advanced (AI)</option>
                                <option [ngValue]="2">Auto (Smart)</option>
                            </select>
                        </label>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-clear" (click)="clear()" [disabled]="loading">
                            Clear
                        </button>
                        <button class="btn-analyze" (click)="analyze()"
                            [disabled]="loading || (!conversationText && selectedImages.length === 0 && !selectedAudio)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                            </svg>
                            {{ draftMessage ? 'Analyze with Draft' : 'Analyze' }}
                        </button>
                    </div>
                </div>

                <!-- Permission Info -->
                <div class="permissions-info" *ngIf="permissions && !isAdmin">
                    <p class="permissions-title">Your enabled features:</p>
                    <div class="feature-badges">
                        <span class="feature-badge" [class.enabled]="permissions.UnansweredQuestions || permissions.unansweredQuestions">
                            Unanswered Questions
                        </span>
                        <span class="feature-badge" [class.enabled]="permissions.TensionPoints || permissions.tensionPoints">
                            Tension Points
                        </span>
                        <span class="feature-badge" [class.enabled]="permissions.Misalignments || permissions.misalignments">
                            Misalignments
                        </span>
                        <span class="feature-badge" [class.enabled]="permissions.ConversationHealth || permissions.conversationHealth">
                            Conversation Health
                        </span>
                        <span class="feature-badge" [class.enabled]="permissions.SuggestedActions || permissions.suggestedActions">
                            Suggested Actions
                        </span>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="error-message" *ngIf="error">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
                </svg>
                {{ error }}
            </div>

            <!-- Draft Analysis Results -->
            <div class="draft-analysis-section" *ngIf="draftAnalysis">
                <div class="section-header">
                    <h2>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                        Draft Analysis
                    </h2>
                </div>

                <!-- Ready to Send Indicator -->
                <div class="ready-indicator" [class.ready]="draftAnalysis.readyToSend" [class.needs-work]="!draftAnalysis.readyToSend">
                    <svg *ngIf="draftAnalysis.readyToSend" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <svg *ngIf="!draftAnalysis.readyToSend" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    {{ draftAnalysis.readyToSend ? 'Ready to Send' : 'Needs Work' }}
                </div>

                <!-- Overall Assessment -->
                <p class="overall-assessment">{{ draftAnalysis.overallAssessment }}</p>

                <!-- Completeness Score -->
                <div class="completeness-section">
                    <h3>Completeness</h3>
                    <div class="score-bar-container">
                        <div class="score-bar">
                            <div class="score-fill" [style.width.%]="draftAnalysis.completenessScore * 10"></div>
                        </div>
                        <span class="score-label">{{ draftAnalysis.completenessScore }}/10</span>
                    </div>
                </div>

                <!-- Tone Assessment -->
                <div class="tone-section" *ngIf="draftAnalysis.tone">
                    <h3>Tone Assessment</h3>
                    <div class="tone-badges">
                        <span class="tone-badge">{{ draftAnalysis.tone.tone }}</span>
                        <span class="match-badge" [class.matches]="draftAnalysis.tone.matchesConversationTone"
                            [class.no-match]="!draftAnalysis.tone.matchesConversationTone">
                            {{ draftAnalysis.tone.matchesConversationTone ? 'âœ“ Matches conversation tone' : 'âš  Different tone than conversation' }}
                        </span>
                        <span class="escalation-badge" *ngIf="draftAnalysis.tone.escalationRisk !== 'none'"
                            [class.low]="draftAnalysis.tone.escalationRisk === 'low'"
                            [class.medium]="draftAnalysis.tone.escalationRisk === 'medium'"
                            [class.high]="draftAnalysis.tone.escalationRisk === 'high'">
                            Escalation Risk: {{ draftAnalysis.tone.escalationRisk }}
                        </span>
                    </div>
                    <p class="tone-explanation">{{ draftAnalysis.tone.explanation }}</p>
                </div>

                <!-- Questions Covered -->
                <div class="questions-section" *ngIf="draftAnalysis.questionsCovered?.length">
                    <h3>Questions Addressed</h3>
                    <ul class="questions-list">
                        <li *ngFor="let q of draftAnalysis.questionsCovered" [class.addressed]="q.addressed" [class.not-addressed]="!q.addressed">
                            <span class="question-status">{{ q.addressed ? 'âœ“' : 'âœ—' }}</span>
                            <span class="question-text">{{ q.question }}</span>
                            <span class="how-addressed" *ngIf="q.addressed && q.howAddressed">{{ q.howAddressed }}</span>
                        </li>
                    </ul>
                </div>

                <!-- Questions Ignored -->
                <div class="warning-section" *ngIf="draftAnalysis.questionsIgnored?.length">
                    <h3>âš  Questions Not Addressed</h3>
                    <ul class="ignored-list">
                        <li *ngFor="let q of draftAnalysis.questionsIgnored">{{ q }}</li>
                    </ul>
                </div>

                <!-- New Questions Introduced -->
                <div class="new-questions-section" *ngIf="draftAnalysis.newQuestionsIntroduced?.length">
                    <h3>New Questions You're Asking</h3>
                    <ul class="new-questions-list">
                        <li *ngFor="let q of draftAnalysis.newQuestionsIntroduced">{{ q }}</li>
                    </ul>
                </div>

                <!-- Risk Flags -->
                <div class="risks-section" *ngIf="draftAnalysis.riskFlags?.length">
                    <h3>Risk Flags</h3>
                    <div class="risk-item" *ngFor="let risk of draftAnalysis.riskFlags"
                        [class.low]="risk.severity === 'low'"
                        [class.medium]="risk.severity === 'medium'"
                        [class.high]="risk.severity === 'high'">
                        <div class="risk-header">
                            <span class="risk-type">{{ risk.type }}</span>
                            <span class="risk-severity">{{ risk.severity }}</span>
                        </div>
                        <p class="risk-description">{{ risk.description }}</p>
                        <p class="risk-suggestion">ðŸ’¡ {{ risk.suggestion }}</p>
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="suggestions-section" *ngIf="draftAnalysis.suggestions?.length">
                    <h3>Suggestions</h3>
                    <ul class="suggestions-list">
                        <li *ngFor="let s of draftAnalysis.suggestions">{{ s }}</li>
                    </ul>
                </div>
            </div>

            <!-- Results Display -->
            <app-results-display *ngIf="results" [results]="results"></app-results-display>
        </div>
    </div>
</div>
